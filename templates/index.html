<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelter Survival - Web Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #e6e6e6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid #444;
        }

        .header h1 {
            color: #ffd700;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .main-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #444;
        }

        .sidebar {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #444;
        }

        .section {
            margin-bottom: 20px;
        }

        .section h3 {
            color: #ffd700;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .resource-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #555;
        }

        .resource-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }

        .people-list, .rooms-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            padding: 10px;
        }

        .rooms-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .person-item, .room-item {
            padding: 5px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            border-left: 3px solid #ffd700;
        }

        .room-item {
            margin-bottom: 0;
            padding: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .actions-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #444;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: #ecf0f1;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            transition: all 0.3s ease;
            border: 1px solid #555;
        }

        .action-btn:hover {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ffd700;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background: rgba(0, 0, 0, 0.3);
            color: #e6e6e6;
            font-family: 'Courier New', monospace;
        }

        .btn-primary {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            transform: translateY(-2px);
        }

        .game-log {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid #555;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-entry.info {
            color: #3498db;
        }

        .log-entry.success {
            color: #27ae60;
        }

        .log-entry.warning {
            color: #f39c12;
        }

        .log-entry.error {
            color: #e74c3c;
        }

        .hidden {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #2c3e50;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        .trade-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .trade-section {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
        }

        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            background: #2c3e50;
            border-radius: 4px;
        }

        .trade-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .person-item {
            background: #34495e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #2c3e50;
            transition: all 0.3s ease;
        }

        .person-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .person-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .person-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background: #2c3e50;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .person-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .person-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
        }

        .person-btn.assign {
            background: #27ae60;
            color: white;
        }

        .person-btn.assign:hover {
            background: #229954;
        }

        .person-btn.unassign {
            background: #e74c3c;
            color: white;
        }

        .person-btn.unassign:hover {
            background: #c0392b;
        }

        .person-btn.eat {
            background: #f39c12;
            color: white;
        }

        .person-btn.eat:hover {
            background: #e67e22;
        }

        .person-btn.drink {
            background: #3498db;
            color: white;
        }

        .person-btn.drink:hover {
            background: #2980b9;
        }

        .person-btn.scavenge {
            background: #9b59b6;
            color: white;
        }

        .person-btn.scavenge:hover {
            background: #8e44ad;
        }

        .person-btn.return {
            background: #e67e22;
            color: white;
        }

        .person-btn.return:hover {
            background: #d35400;
        }

        .person-btn.info {
            background: #1abc9c;
            color: white;
        }

        .person-btn.info:hover {
            background: #16a085;
        }

        .person-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .person-info-details {
            padding: 20px;
            color: #2c3e50;
        }

        .person-info-details h4 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.5em;
        }

        .person-info-details h5 {
            margin: 20px 0 10px 0;
            color: #34495e;
            font-size: 1.2em;
        }

        .person-info-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            color: #2c3e50;
        }

        .equipped-info, .medical-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .equipped-item, .medical-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            color: #2c3e50;
        }

        .inventory-info {
            margin-bottom: 20px;
        }

        .inventory-capacity {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .inventory-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
        }

        .inventory-item {
            padding: 6px 10px;
            background: #bdc3c7;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
        }

        .person-special-stats {
            margin: 10px 0;
        }

        .special-stats-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .special-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px;
            background: #2c3e50;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .stat-label {
            font-weight: bold;
            color: #3498db;
        }

        .stat-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .person-equipped {
            margin: 10px 0;
            padding: 8px;
            background: #2c3e50;
            border-radius: 4px;
        }

        .equipped-item {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            font-size: 0.9em;
        }

        .person-medical {
            margin: 10px 0;
            padding: 8px;
            background: #2c3e50;
            border-radius: 4px;
        }

        .medical-item {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            font-size: 0.9em;
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .room-option {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .room-option:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .room-option.current {
            border-color: #f39c12;
            background: #2c3e50;
        }

        .room-option.full {
            border-color: #e74c3c;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .room-option.full:hover {
            transform: none;
        }

        .room-capacity {
            font-size: 0.8em;
            color: #bdc3c7;
            margin-top: 5px;
        }

        .transfer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .transfer-section {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
        }

        .transfer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            background: #2c3e50;
            border-radius: 4px;
        }

        .transfer-controls {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .transfer-item-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .transfer-item-selector label {
            color: #ffd700;
        }

        .transfer-item-selector select, .transfer-item-selector input {
            width: 150px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background: rgba(0, 0, 0, 0.3);
            color: #e6e6e6;
            font-family: 'Courier New', monospace;
        }

        .transfer-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }

            .person-actions {
                flex-direction: column;
            }

            .rooms-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Shelter Survival</h1>
            <p>Web Edition - Fallout Shelter Text-Based Game</p>
        </div>

        <!-- New Game Form -->
        <div id="new-game-form" class="main-content">
            <h3>Start New Game</h3>
            <form id="game-form">
                <div class="input-group">
                    <label for="player-name">Your First Name:</label>
                    <input type="text" id="player-name" value="Walter" required>
                </div>
                <div class="input-group">
                    <label for="father-surname">Father's Surname:</label>
                    <input type="text" id="father-surname" value="Reed" required>
                </div>
                <div class="input-group">
                    <label for="mother-surname">Mother's Surname:</label>
                    <input type="text" id="mother-surname" value="Rogers" required>
                </div>
                <div class="input-group">
                    <label for="gender">Gender:</label>
                    <select id="gender">
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Start New Game</button>
            </form>
        </div>

        <!-- Game Interface -->
        <div id="game-interface" class="hidden">
            <div class="game-area">
                <div class="main-content">
                    <div class="section">
                        <h3>üè† Vault Status</h3>
                        <div class="resource-grid" id="resources">
                            <!-- Resources will be populated here -->
                        </div>
                    </div>

                    <div class="section">
                        <h3>üë• Inhabitants</h3>
                        <div class="people-list" id="people">
                            <!-- People will be populated here -->
                        </div>
                    </div>

                    <div class="section">
                        <h3>üèóÔ∏è Rooms</h3>
                        <div class="rooms-list" id="rooms">
                            <!-- Rooms will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="section">
                        <h3>üè† Global Inventory</h3>
                        <div id="global-inventory">
                            <!-- Global inventory will be populated here -->
                        </div>
                    </div>

                    <div class="section">
                        <h3>üéí Player Inventory</h3>
                        <div id="player-inventory">
                            <!-- Player inventory will be populated here -->
                        </div>
                    </div>

                    <div class="section">
                        <h3>üìù Game Log</h3>
                        <div class="game-log" id="game-log">
                            <!-- Game log will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions-area">
                <h3>‚ö° Actions</h3>
                <div class="action-buttons" id="action-buttons">
                    <!-- Action buttons will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Modal -->
    <div id="trade-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ Trading Post</h3>
                <span class="close" onclick="document.getElementById('trade-modal').style.display='none'">&times;</span>
            </div>
            <div class="trade-grid">
                <div class="trade-section">
                    <h4>üéí Your Inventory</h4>
                    <div id="player-trade-inventory">
                        <!-- Player inventory will be populated here -->
                    </div>
                </div>
                <div class="trade-section">
                    <h4>üè™ Trader's Inventory</h4>
                    <div id="trader-trade-inventory">
                        <!-- Trader inventory will be populated here -->
                    </div>
                </div>
            </div>
            <div class="trade-buttons">
                <button class="btn-secondary" onclick="document.getElementById('trade-modal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <!-- Room Assignment Modal -->
    <div id="room-assignment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üè† Assign to Room</h3>
                <span class="close" onclick="document.getElementById('room-assignment-modal').style.display='none'">&times;</span>
            </div>
            <div class="room-assignment-content">
                <h4 id="assignment-person-name">Assigning: </h4>
                <div class="rooms-grid" id="available-rooms">
                    <!-- Available rooms will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Person Info Modal -->
    <div id="person-info-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ Person Details</h3>
                <span class="close" onclick="document.getElementById('person-info-modal').style.display='none'">&times;</span>
            </div>
            <div id="person-info-content">
                <!-- Person details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîÑ Transfer Items</h3>
                <span class="close" onclick="document.getElementById('transfer-modal').style.display='none'">&times;</span>
            </div>
            <div class="transfer-grid">
                <div class="transfer-section">
                    <h4>üè† Global Inventory</h4>
                    <div id="transfer-global-inventory">
                        <!-- Global inventory for transfer will be populated here -->
                    </div>
                </div>
                <div class="transfer-section">
                    <h4>üéí Player Inventory</h4>
                    <div id="transfer-player-inventory">
                        <!-- Player inventory for transfer will be populated here -->
                    </div>
                </div>
            </div>
            <div class="transfer-controls">
                <div class="transfer-item-selector">
                    <label for="transfer-item">Item:</label>
                    <select id="transfer-item">
                        <option value="">Select an item...</option>
                    </select>
                    <label for="transfer-quantity">Quantity:</label>
                    <input type="number" id="transfer-quantity" min="1" value="1">
                    <button class="btn-primary" onclick="game.transferItem()">Transfer</button>
                </div>
            </div>
            <div class="transfer-buttons">
                <button class="btn-secondary" onclick="document.getElementById('transfer-modal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <script>
        class ShelterGame {
            constructor() {
                this.gameState = null;
                this.actions = [];
                this.baseUrl = 'http://localhost:5002'; // Updated port
                this.init();
            }

            async init() {
                this.bindEvents();
                // Don't load actions until we have an active game
            }

            bindEvents() {
                document.getElementById('game-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.startNewGame();
                });
            }

            async startNewGame() {
                const formData = {
                    player_name: document.getElementById('player-name').value,
                    father_surname: document.getElementById('father-surname').value,
                    mother_surname: document.getElementById('mother-surname').value,
                    gender: document.getElementById('gender').value
                };

                try {
                    const response = await fetch(`${this.baseUrl}/api/new_game`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.gameState = result.game_state;
                        this.showGameInterface();
                        this.updateDisplay();
                        this.log('New game started! Welcome to the vault.', 'success');
                        // Now load actions after game is created
                        await this.loadActions();
                    } else {
                        this.log('Failed to start game: ' + result.error, 'error');
                    }
                } catch (error) {
                    this.log('Error starting game: ' + error.message, 'error');
                }
            }

            async loadActions() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/actions`);
                    if (response.ok) {
                        this.actions = await response.json();
                        this.renderActions();
                    } else {
                        this.log('No active game session', 'warning');
                    }
                } catch (error) {
                    this.log('Error loading actions: ' + error.message, 'error');
                }
            }

            showGameInterface() {
                document.getElementById('new-game-form').classList.add('hidden');
                document.getElementById('game-interface').classList.remove('hidden');
            }

            showNewGameForm() {
                document.getElementById('game-interface').classList.add('hidden');
                document.getElementById('new-game-form').classList.remove('hidden');
                this.gameState = null;
                this.actions = [];
                this.log('Returned to main screen.', 'info');
            }

            async updateDisplay() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/game_state`);
                    if (response.ok) {
                        this.gameState = await response.json();
                        this.renderGameState();
                    } else {
                        this.log('No active game session', 'warning');
                    }
                } catch (error) {
                    this.log('Error updating game state: ' + error.message, 'error');
                }
            }

            renderGameState() {
                this.renderResources();
                this.renderPeople();
                this.renderRooms();
                this.renderInventory();
            }

            renderResources() {
                const resources = this.gameState.resources;
                const container = document.getElementById('resources');
                container.innerHTML = `
                    <div class="resource-item">
                        <div>üí∞ Caps</div>
                        <div class="resource-value">${resources.caps}</div>
                    </div>
                    <div class="resource-item">
                        <div>üòä Happiness</div>
                        <div class="resource-value">${resources.happiness}%</div>
                    </div>
                    <div class="resource-item">
                        <div>‚ö° Action Points</div>
                        <div class="resource-value">${resources.action_points}</div>
                    </div>
                    <div class="resource-item">
                        <div>üìÖ Day</div>
                        <div class="resource-value">${resources.days}</div>
                    </div>
                    <div class="resource-item">
                        <div>üõ°Ô∏è Defense</div>
                        <div class="resource-value">${resources.defense}</div>
                    </div>
                    <div class="resource-item">
                        <div>üçΩÔ∏è Auto Feed</div>
                        <div class="resource-value">
                            <input type="checkbox" id="auto-feed-checkbox" ${resources.auto_feed_enabled ? 'checked' : ''} onchange="game.toggleAutoFeed()">
                        </div>
                    </div>
                `;
            }

            renderPeople() {
                const people = this.gameState.people;
                const container = document.getElementById('people');
                container.innerHTML = '';

                // Add player first
                const player = this.gameState.player;
                const isPlayerAssigned = player.room !== null;
                container.innerHTML += `
                    <div class="person-item" data-person="player">
                        <div class="person-header">
                            <div class="person-name">üë§ ${player.name}</div>
                            <div>${isPlayerAssigned ? `üè† ${player.room}` : 'üè† Unassigned'}</div>
                        </div>
                        <div class="person-stats">
                            <div class="stat-item">
                                <span>Age:</span>
                                <span>${player.age}</span>
                            </div>
                            <div class="stat-item">
                                <span>Gender:</span>
                                <span>${player.gender}</span>
                            </div>
                            <div class="stat-item">
                                <span>Health:</span>
                                <span>${player.health}%</span>
                            </div>
                            <div class="stat-item">
                                <span>Hunger:</span>
                                <span>${player.hunger}%</span>
                            </div>
                            <div class="stat-item">
                                <span>Thirst:</span>
                                <span>${player.thirst}%</span>
                            </div>
                            <div class="stat-item">
                                <span>Radiation:</span>
                                <span>${player.radiation}%</span>
                            </div>
                        </div>

                        <div class="person-actions">
                            <button class="person-btn assign" onclick="game.assignPerson('player')">Assign</button>
                            <button class="person-btn unassign" onclick="game.unassignPerson('player')" ${!isPlayerAssigned ? 'disabled' : ''}>Unassign</button>
                            <button class="person-btn eat" onclick="game.feedPerson('player')">Eat</button>
                            <button class="person-btn drink" onclick="game.drinkPerson('player')">Drink</button>
                            <button class="person-btn scavenge" onclick="game.scavengePerson('player')" ${player.is_scavenging ? 'disabled' : ''}>Scavenge</button>
                            <button class="person-btn return" onclick="game.returnPerson('player')" ${!player.is_scavenging ? 'disabled' : ''}>Return</button>
                            <button class="person-btn info" onclick="game.showPersonInfo('player')">Get Info</button>
                        </div>
                    </div>
                `;

                // Add other people
                Object.entries(people).forEach(([name, person]) => {
                    if (person.alive) {
                        const isAssigned = person.room !== null;
                        container.innerHTML += `
                            <div class="person-item" data-person="${name}">
                                <div class="person-header">
                                    <div class="person-name">üë§ ${person.name}</div>
                                    <div>${isAssigned ? `üè† ${person.room}` : 'üè† Unassigned'}</div>
                                </div>
                                <div class="person-stats">
                                    <div class="stat-item">
                                        <span>Age:</span>
                                        <span>${person.age}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Gender:</span>
                                        <span>${person.gender}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Health:</span>
                                        <span>${person.health}%</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Hunger:</span>
                                        <span>${person.hunger}%</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Thirst:</span>
                                        <span>${person.thirst}%</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Radiation:</span>
                                        <span>${person.radiation}%</span>
                                    </div>
                                </div>

                                                                    <div class="person-actions">
                                        <button class="person-btn assign" onclick="game.assignPerson('${name}')">Assign</button>
                                        <button class="person-btn unassign" onclick="game.unassignPerson('${name}')" ${!isAssigned ? 'disabled' : ''}>Unassign</button>
                                        <button class="person-btn eat" onclick="game.feedPerson('${name}')">Eat</button>
                                        <button class="person-btn drink" onclick="game.drinkPerson('${name}')">Drink</button>
                                        <button class="person-btn scavenge" onclick="game.scavengePerson('${name}')" ${person.is_scavenging ? 'disabled' : ''}>Scavenge</button>
                                        <button class="person-btn return" onclick="game.returnPerson('${name}')" ${!person.is_scavenging ? 'disabled' : ''}>Return</button>
                                        <button class="person-btn info" onclick="game.showPersonInfo('${name}')">Get Info</button>
                                    </div>
                            </div>
                        `;
                    }
                });
            }

            renderRooms() {
                const rooms = this.gameState.rooms;
                const container = document.getElementById('rooms');
                container.innerHTML = '';

                Object.entries(rooms).forEach(([name, room]) => {
                    let specialFeatures = '';
                    if (room.free_sleeping) {
                        specialFeatures += '<br>üÜì Free Sleeping Area';
                    }
                    if (room.produce === 'happiness') {
                        specialFeatures += '<br>üòä Produces Happiness';
                    }
                    
                    container.innerHTML += `
                        <div class="room-item">
                            <strong>üè† ${name}</strong><br>
                            Built: ${room.built ? '‚úÖ' : '‚ùå'}<br>
                            Assigned: ${room.assigned ? '‚úÖ' : '‚ùå'}<br>
                            ${room.produce ? `Produces: ${room.produce} (${room.production})` : ''}<br>
                            Power: ${room.wattage}W${specialFeatures}
                        </div>
                    `;
                });
            }

            renderInventory() {
                const globalInventory = this.gameState.global_inventory;
                const playerInventory = this.gameState.player_inventory;
                const globalInventoryContainer = document.getElementById('global-inventory');
                const playerInventoryContainer = document.getElementById('player-inventory');

                globalInventoryContainer.innerHTML = '';
                playerInventoryContainer.innerHTML = '';

                Object.entries(globalInventory).forEach(([item, count]) => {
                    if (count > 0) {
                        globalInventoryContainer.innerHTML += `
                            <div class="resource-item">
                                <div>üì¶ ${item}</div>
                                <div class="resource-value">${count}</div>
                            </div>
                        `;
                    }
                });

                Object.entries(playerInventory).forEach(([item, count]) => {
                    if (count > 0) {
                        playerInventoryContainer.innerHTML += `
                            <div class="resource-item">
                                <div>üì¶ ${item}</div>
                                <div class="resource-value">${count}</div>
                            </div>
                        `;
                    }
                });
            }

            renderActions() {
                const container = document.getElementById('action-buttons');
                container.innerHTML = '';

                // Only show specific actions
                const allowedActions = ['quit', 'auto assign all', 'auto feed all', 'skip'];
                
                this.actions.forEach(action => {
                    if (allowedActions.includes(action)) {
                        const button = document.createElement('button');
                        button.className = 'action-btn';
                        button.textContent = this.capitalizeAction(action);
                        button.onclick = () => this.performAction(action);
                        container.appendChild(button);
                    }
                });

                // Add special buttons
                const skipButton = document.createElement('button');
                skipButton.className = 'action-btn';
                skipButton.textContent = '‚è≠Ô∏è Skip Day';
                skipButton.onclick = () => this.skipDay();
                container.appendChild(skipButton);

                // Add transfer button
                const transferButton = document.createElement('button');
                transferButton.className = 'action-btn';
                transferButton.textContent = 'üîÑ Transfer Items';
                transferButton.onclick = () => this.showTransferModal();
                container.appendChild(transferButton);
            }

            capitalizeAction(action) {
                // Convert action names to proper case
                const actionMap = {
                    'quit': 'Quit',
                    'skip': 'Skip',
                    'help': 'Help',
                    'see day': 'See Day',
                    'see people': 'See People',
                    'see inventory': 'See Inventory',
                    'see items': 'See Items',
                    'see rooms': 'See Rooms',
                    'see resources': 'See Resources',
                    'auto assign all': 'Auto Assign All',
                    'trade': 'Trade',
                    'craft': 'Craft',
                    'rush': 'Rush',
                    'assign': 'Assign',
                    'unassign': 'Unassign',
                    'auto feed all': 'Auto Feed All',
                    'coitus': 'Coitus',
                    'build': 'Build',
                    'fix': 'Fix',
                    'heal': 'Heal'
                };
                return actionMap[action] || action;
            }

            async performAction(action) {
                // Handle special actions
                if (action === 'trade') {
                    this.showTradeModal();
                    return;
                }

                try {
                    const response = await fetch(`${this.baseUrl}/api/perform_action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: action,
                            args: []
                        })
                    });

                    const result = await response.json();

                    // Debug: log the full result for 'see' actions (removed verbose debug)
                    if (action.startsWith('see ')) {
                        // Removed verbose debug output
                    }
                    
                    // Handle quit action
                    if (result.quit) {
                        this.log(result.message, 'success');
                        this.showNewGameForm();
                        return;
                    }
                    
                    this.gameState = result.game_state;
                    this.renderGameState();
                    
                    if (result.result && result.result.success) {
                        this.log(`Action '${action}' completed successfully.`, 'success');
                        
                        // Handle actions that return data (like see_people)
                        let data = result.result.data;
                        if (data && (Array.isArray(data) || typeof data === 'object')) {
                            if (Array.isArray(data)) {
                                data.forEach(line => {
                                    this.log(line, 'info');
                                });
                            } else if (typeof data === 'object') {
                                // For inventory/items, display in a more readable format
                                if (action === 'see items' || action === 'see inventory') {
                                    Object.entries(data).forEach(([item, count]) => {
                                        this.log(`${item}: ${count}`, 'info');
                                    });
                                } else {
                                    this.log(JSON.stringify(data), 'info');
                                }
                            }
                        }
                    } else if (result.result && result.result.error) {
                        this.log(`Action '${action}' failed: ${result.result.error}`, 'error');
                    } else {
                        this.log(`Action '${action}' executed.`, 'info');
                    }
                } catch (error) {
                    this.log(`Error performing action '${action}': ${error.message}`, 'error');
                }
            }

            showTradeModal() {
                const modal = document.getElementById('trade-modal');
                const playerInventory = document.getElementById('player-trade-inventory');
                const traderInventory = document.getElementById('trader-trade-inventory');
                
                // Populate player inventory
                playerInventory.innerHTML = '';
                Object.entries(this.gameState.inventory).forEach(([item, count]) => {
                    if (count > 0) {
                        playerInventory.innerHTML += `
                            <div class="trade-item">
                                <span>üì¶ ${item}</span>
                                <span>${count}</span>
                            </div>
                        `;
                    }
                });
                
                // Populate trader inventory (simplified)
                traderInventory.innerHTML = `
                    <div class="trade-item">
                        <span>üí∞ Caps</span>
                        <span>500</span>
                    </div>
                    <div class="trade-item">
                        <span>üîß Steel</span>
                        <span>20</span>
                    </div>
                    <div class="trade-item">
                        <span>üíä Medkit</span>
                        <span>5</span>
                    </div>
                    <div class="trade-item">
                        <span>üçñ Food</span>
                        <span>15</span>
                    </div>
                    <div class="trade-item">
                        <span>üíß Water</span>
                        <span>15</span>
                    </div>
                `;
                
                modal.style.display = 'block';
            }

            async skipDay() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/update_day`, {
                        method: 'POST'
                    });

                    const result = await response.json();
                    this.gameState = result.game_state;
                    this.renderGameState();
                    this.log(result.message, 'success');
                } catch (error) {
                    this.log('Error skipping day: ' + error.message, 'error');
                }
            }

            log(message, type = 'info') {
                const logContainer = document.getElementById('game-log');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            async assignPerson(personName) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/available_rooms`);
                    if (response.ok) {
                        const availableRooms = await response.json();
                        this.showRoomAssignmentModal(personName, availableRooms);
                    } else {
                        this.log('Error loading available rooms', 'error');
                    }
                } catch (error) {
                    this.log('Error loading available rooms: ' + error.message, 'error');
                }
            }

            async unassignPerson(personName) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/perform_action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'unassign',
                            args: [personName]
                        })
                    });

                    const result = await response.json();
                    if (result.result && result.result.success) {
                        this.gameState = result.game_state;
                        this.renderGameState();
                        this.log(`Unassigned ${personName} from their room.`, 'success');
                    } else {
                        this.log(`Failed to unassign ${personName}: ${result.result?.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.log(`Error unassigning ${personName}: ${error.message}`, 'error');
                }
            }

            async feedPerson(personName) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/perform_action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'feed',
                            args: [personName]
                        })
                    });

                    const result = await response.json();
                    if (result.result && result.result.success) {
                        this.gameState = result.game_state;
                        this.renderGameState();
                        this.log(`Fed ${personName}.`, 'success');
                    } else {
                        this.log(`Failed to feed ${personName}: ${result.result?.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.log(`Error feeding ${personName}: ${error.message}`, 'error');
                }
            }

            async drinkPerson(personName) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/perform_action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'drink',
                            args: [personName]
                        })
                    });

                    const result = await response.json();
                    if (result.result && result.result.success) {
                        this.gameState = result.game_state;
                        this.renderGameState();
                        this.log(`Gave water to ${personName}.`, 'success');
                    } else {
                        this.log(`Failed to give water to ${personName}: ${result.result?.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.log(`Error giving water to ${personName}: ${error.message}`, 'error');
                }
            }

            async scavengePerson(personName) {
                const days = prompt(`How many days should ${personName} scavenge? (1-10):`);
                if (days && !isNaN(days) && days >= 1 && days <= 10) {
                    try {
                        const response = await fetch(`${this.baseUrl}/api/perform_action`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                action: 'scavenge',
                                args: [personName, parseInt(days)]
                            })
                        });

                        const result = await response.json();
                        if (result.result && result.result.success) {
                            this.gameState = result.game_state;
                            this.renderGameState();
                            this.log(`${personName} has left to scavenge for ${days} days.`, 'success');
                        } else {
                            this.log(`Failed to send ${personName} scavenging: ${result.result?.error || 'Unknown error'}`, 'error');
                        }
                    } catch (error) {
                        this.log(`Error sending ${personName} scavenging: ${error.message}`, 'error');
                    }
                }
            }

            async returnPerson(personName) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/perform_action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'return',
                            args: [personName]
                        })
                    });

                    const result = await response.json();
                    if (result.result && result.result.success) {
                        this.gameState = result.game_state;
                        this.renderGameState();
                        this.log(`${personName} has returned from scavenging.`, 'success');
                    } else {
                        this.log(`Failed to return ${personName}: ${result.result?.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.log(`Error returning ${personName}: ${error.message}`, 'error');
                }
            }

            async toggleAutoFeed() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/perform_action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'toggle auto feed',
                            args: []
                        })
                    });

                    const result = await response.json();
                    if (result.result && result.result.success) {
                        this.gameState = result.game_state;
                        this.renderGameState();
                        this.log(result.result.message, 'success');
                    } else {
                        this.log(`Failed to toggle auto-feed: ${result.result?.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.log(`Error toggling auto-feed: ${error.message}`, 'error');
                }
            }

            showPersonInfo(personName) {
                let person;
                if (personName === 'player') {
                    person = this.gameState.player;
                } else {
                    person = this.gameState.people[personName];
                }

                if (!person) {
                    this.log(`Person ${personName} not found.`, 'error');
                    return;
                }

                const modal = document.getElementById('person-info-modal');
                const content = document.getElementById('person-info-content');

                content.innerHTML = `
                    <div class="person-info-details">
                        <h4>${person.name}</h4>
                        <div class="person-info-stats">
                            <div class="info-stat">
                                <span>Age:</span>
                                <span>${person.age}</span>
                            </div>
                            <div class="info-stat">
                                <span>Gender:</span>
                                <span>${person.gender}</span>
                            </div>
                            <div class="info-stat">
                                <span>Health:</span>
                                <span>${person.health}%</span>
                            </div>
                            <div class="info-stat">
                                <span>Hunger:</span>
                                <span>${person.hunger}%</span>
                            </div>
                            <div class="info-stat">
                                <span>Thirst:</span>
                                <span>${person.thirst}%</span>
                            </div>
                            <div class="info-stat">
                                <span>Radiation:</span>
                                <span>${person.radiation}%</span>
                            </div>
                        </div>
                        
                        <h5>SPECIAL Stats</h5>
                        <div class="special-stats-grid">
                            <div class="special-stat">
                                <span class="stat-label">S</span>
                                <span class="stat-value">${person.stats.S}</span>
                            </div>
                            <div class="special-stat">
                                <span class="stat-label">P</span>
                                <span class="stat-value">${person.stats.P}</span>
                            </div>
                            <div class="special-stat">
                                <span class="stat-label">E</span>
                                <span class="stat-value">${person.stats.E}</span>
                            </div>
                            <div class="special-stat">
                                <span class="stat-label">C</span>
                                <span class="stat-value">${person.stats.C}</span>
                            </div>
                            <div class="special-stat">
                                <span class="stat-label">I</span>
                                <span class="stat-value">${person.stats.I}</span>
                            </div>
                            <div class="special-stat">
                                <span class="stat-label">A</span>
                                <span class="stat-value">${person.stats.A}</span>
                            </div>
                            <div class="special-stat">
                                <span class="stat-label">L</span>
                                <span class="stat-value">${person.stats.L}</span>
                            </div>
                        </div>
                        
                        <h5>Equipment</h5>
                        <div class="equipped-info">
                            <div class="equipped-item">
                                <span>Weapon:</span>
                                <span>${person.equipped.weapon ? person.equipped.weapon.name : 'None'}</span>
                            </div>
                            <div class="equipped-item">
                                <span>Armor:</span>
                                <span>${person.equipped.armor ? person.equipped.armor.name : 'None'}</span>
                            </div>
                            <div class="equipped-item">
                                <span>Outfit:</span>
                                <span>${person.equipped.outfit ? person.equipped.outfit.name : 'None'}</span>
                            </div>
                        </div>
                        
                        <h5>Medical Supplies</h5>
                        <div class="medical-info">
                            <div class="medical-item">
                                <span>Stimpaks:</span>
                                <span>${person.stimpaks}</span>
                            </div>
                            <div class="medical-item">
                                <span>RadAway:</span>
                                <span>${person.radaways}</span>
                            </div>
                        </div>
                        
                        <h5>Personal Inventory</h5>
                        <div class="inventory-info">
                            <div class="inventory-capacity">
                                <span>Capacity:</span>
                                <span>${person.inventory.length}/${person.inventory_capacity}</span>
                            </div>
                            <div class="inventory-items">
                                ${person.inventory.length > 0 ? person.inventory.map(item => 
                                    `<div class="inventory-item">${item.name || item.type}</div>`
                                ).join('') : '<div class="inventory-item">Empty</div>'}
                            </div>
                        </div>
                    </div>
                `;

                modal.style.display = 'block';
            }

            showRoomAssignmentModal(personName, availableRooms) {
                const modal = document.getElementById('room-assignment-modal');
                const personNameElement = document.getElementById('assignment-person-name');
                const roomsContainer = document.getElementById('available-rooms');
                
                // Get current person info
                let person;
                if (personName === 'player') {
                    person = this.gameState.player;
                } else {
                    person = this.gameState.people[personName];
                }
                
                personNameElement.textContent = `Assigning: ${person.name}`;
                
                // Populate rooms
                roomsContainer.innerHTML = '';
                availableRooms.forEach(room => {
                    const isCurrentRoom = person.room === room.name;
                    const isFull = room.assigned_count >= room.max_capacity;
                    const roomClass = isCurrentRoom ? 'room-option current' : 
                                    isFull ? 'room-option full' : 'room-option';
                    
                    const roomElement = document.createElement('div');
                    roomElement.className = roomClass;
                    roomElement.innerHTML = `
                        <div><strong>${room.name}</strong></div>
                        <div>${room.produce ? `Produces: ${room.produce} (${room.production})` : 'Living space'}</div>
                        <div class="room-capacity">${room.assigned_count}/${room.max_capacity} assigned</div>
                    `;
                    
                    if (!isFull && !isCurrentRoom) {
                        roomElement.onclick = () => this.assignPersonToRoom(personName, room.name);
                    }
                    
                    roomsContainer.appendChild(roomElement);
                });
                
                modal.style.display = 'block';
            }

            async assignPersonToRoom(personName, roomName) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/perform_action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'assign',
                            args: [personName, roomName]
                        })
                    });

                    const result = await response.json();
                    if (result.result && result.result.success) {
                        this.gameState = result.game_state;
                        this.renderGameState();
                        this.log(`Assigned ${personName} to ${roomName}.`, 'success');
                        document.getElementById('room-assignment-modal').style.display = 'none';
                    } else {
                        this.log(`Failed to assign ${personName} to ${roomName}: ${result.result?.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.log(`Error assigning ${personName} to ${roomName}: ${error.message}`, 'error');
                }
            }

            showTransferModal() {
                const modal = document.getElementById('transfer-modal');
                const globalInventoryContainer = document.getElementById('transfer-global-inventory');
                const playerInventoryContainer = document.getElementById('transfer-player-inventory');
                const itemSelect = document.getElementById('transfer-item');

                globalInventoryContainer.innerHTML = '';
                playerInventoryContainer.innerHTML = '';
                itemSelect.innerHTML = '<option value="">Select an item...</option>';

                // Populate global inventory display
                Object.entries(this.gameState.global_inventory).forEach(([item, count]) => {
                    if (count > 0) {
                        globalInventoryContainer.innerHTML += `
                            <div class="transfer-item">
                                <span>üì¶ ${item}</span>
                                <span>${count}</span>
                            </div>
                        `;
                        // Add to dropdown
                        itemSelect.innerHTML += `<option value="${item}">${item} (${count})</option>`;
                    }
                });

                // Populate player inventory display
                Object.entries(this.gameState.player_inventory).forEach(([item, count]) => {
                    if (count > 0) {
                        playerInventoryContainer.innerHTML += `
                            <div class="transfer-item">
                                <span>üì¶ ${item}</span>
                                <span>${count}</span>
                            </div>
                        `;
                    }
                });

                modal.style.display = 'block';
            }

            async transferItem() {
                const itemName = document.getElementById('transfer-item').value;
                const quantity = parseInt(document.getElementById('transfer-quantity').value);

                if (!itemName) {
                    this.log('Please select an item to transfer.', 'warning');
                    return;
                }

                if (quantity <= 0) {
                    this.log('Quantity must be at least 1.', 'warning');
                    return;
                }

                try {
                    const response = await fetch(`${this.baseUrl}/api/transfer_item`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            item_name: itemName,
                            quantity: quantity
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.gameState = result.game_state;
                        this.renderGameState();
                        this.log(`Transferred ${quantity} ${itemName} from global to player inventory.`, 'success');
                        
                        // Refresh the modal content instead of closing it
                        this.showTransferModal();
                        
                        // Reset the form
                        document.getElementById('transfer-item').value = '';
                        document.getElementById('transfer-quantity').value = '1';
                    } else {
                        this.log(`Failed to transfer ${quantity} ${itemName}: ${result.error}`, 'error');
                    }
                } catch (error) {
                    this.log(`Error transferring item: ${error.message}`, 'error');
                }
            }
        }

        // Initialize the game when the page loads
        let game;
        document.addEventListener('DOMContentLoaded', () => {
            game = new ShelterGame();
        });
    </script>
</body>
</html> 